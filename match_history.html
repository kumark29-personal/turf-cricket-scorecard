<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match History - Cricket Scorecard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <div class="container py-4">
        <div class="page-header text-center mb-5"
            style="background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%); color: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(13, 110, 253, 0.2);">
            <h1 class="display-4"><strong>üìã Match History</strong></h1>
            <p class="lead">Explore your complete cricket journey</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <button class="btn btn-modern btn-modern-outline px-4" onclick="window.close()">
                    ‚Üê Back to Scorecard
                </button>
            </div>
        </div>

        <div id="matchHistoryContainer">
            <!-- Matches will be loaded here -->
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="main.js"></script>
    <script>
        // Load and display all matches
        $(document).ready(function () {
            const history = getMatchHistory();
            const container = document.getElementById('matchHistoryContainer');

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <h4>No past matches found</h4>
                        <p>Complete a match and click "Start Fresh Match" to save it here.</p>
                    </div>
                `;
                return;
            }

            // Group matches by matchName
            const groupedMatches = {};
            history.forEach((match) => {
                if (!groupedMatches[match.matchName]) {
                    groupedMatches[match.matchName] = {};
                }
                if (match.inningsType === '1st') {
                    groupedMatches[match.matchName].first = match;
                } else if (match.inningsType === '2nd') {
                    groupedMatches[match.matchName].second = match;
                } else {
                    groupedMatches[match.matchName].single = match;
                }
            });

            let html = '';

            // Display all grouped matches
            Object.keys(groupedMatches).forEach((matchName) => {
                const matchGroup = groupedMatches[matchName];
                const leadingMatchId = (matchGroup.single || matchGroup.first || matchGroup.second).matchId;

                html += `<div class="card match-history-card">`;
                html += `<div class="card-header match-history-header d-flex justify-content-between align-items-center">`;
                html += `<h3 class="mb-0"><strong>${matchName}</strong></h3>`;
                html += `<button class="btn btn-light btn-modern" onclick="downloadMatchPDF('${leadingMatchId}')">üì• Download PDF</button>`;
                html += `</div>`;
                html += `<div class="card-body p-4" style="background: white;">`;

                if (matchGroup.single) {
                    // Single innings match
                    const match = matchGroup.single;
                    const date = new Date(match.timestamp);
                    const formattedDate = date.toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    html += `<div class="text-center py-3">`;
                    html += `<div class="score-display text-primary" style="font-size: 3rem;">${match.finalScore}</div>`;
                    html += `<div class="meta-info mb-4" style="font-size: 1.1rem;">in ${match.totalOvers} overs ‚Ä¢ ${formattedDate}</div>`;
                    html += `<button class="btn btn-modern btn-modern-outline btn-lg" style="min-width: 250px;" onclick="showMatchDetails('${match.matchId}')">`;
                    html += `Details</button>`;
                    html += `</div>`;
                } else {
                    // Two innings match
                    html += `<div class="row g-4">`;

                    // 1st Innings
                    if (matchGroup.first) {
                        const match = matchGroup.first;
                        html += `<div class="col-12 col-md-6">`;
                        html += `<div class="innings-box innings-box-1 text-center py-4">`;
                        html += `<div class="meta-info text-primary mb-1">1ST INNINGS</div>`;
                        html += `<div class="score-display text-primary" style="font-size: 2.5rem;">${match.finalScore}</div>`;
                        html += `<div class="meta-info mb-4">in ${match.totalOvers} overs</div>`;
                        html += `<button class="btn btn-modern btn-modern-outline px-5" onclick="showMatchDetails('${match.matchId}')">`;
                        html += `Details</button>`;
                        html += `</div></div>`;
                    }

                    // 2nd Innings
                    if (matchGroup.second) {
                        const match = matchGroup.second;
                        const firstInnings = matchGroup.first;

                        // Determine result
                        let resultBadge = '';
                        if (firstInnings) {
                            const firstRuns = firstInnings.runs;
                            const secondRuns = match.runs;
                            if (secondRuns > firstRuns) {
                                resultBadge = '<span class="badge bg-success ms-2" style="font-size: 0.9rem;">Winner</span>';
                            } else if (secondRuns === firstRuns) {
                                resultBadge = '<span class="badge bg-warning ms-2" style="font-size: 0.9rem;">Tie</span>';
                            } else {
                                resultBadge = '<span class="badge bg-danger ms-2" style="font-size: 0.9rem;">Runner Up</span>';
                            }
                        }

                        html += `<div class="col-12 col-md-6">`;
                        html += `<div class="innings-box innings-box-2 text-center py-4">`;
                        html += `<div class="meta-info text-success mb-1">2ND INNINGS ${resultBadge}</div>`;
                        html += `<div class="score-display text-success" style="font-size: 2.5rem;">${match.finalScore}</div>`;
                        html += `<div class="meta-info mb-4">in ${match.totalOvers} overs</div>`;
                        html += `<button class="btn btn-modern btn-modern-outline px-5" style="border-color: #28a745; color: #28a745;" onclick="showMatchDetails('${match.matchId}')">`;
                        html += `Details</button>`;
                        html += `</div></div>`;
                    }

                    html += `</div>`; // End row

                    // Show timestamp
                    if (matchGroup.first || matchGroup.second) {
                        const match = matchGroup.second || matchGroup.first;
                        const date = new Date(match.timestamp);
                        const formattedDate = date.toLocaleDateString('en-IN', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        html += `<div class="text-center mt-4">`;
                        html += `<div class="meta-info" style="font-size: 1rem;">Played on ${formattedDate}</div>`;
                        html += `</div>`;
                    }
                }

                html += `</div>`; // End card-body
                html += `</div>`; // End match-card
            });

            container.innerHTML = html;
        });
    </script>

    <!-- Match Details Modal (same as in index.html) -->
    <div class="modal fade" id="matchDetailsModal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="matchDetailsTitle">Match Details</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="matchDetailsBody">
                    <!-- Match details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>