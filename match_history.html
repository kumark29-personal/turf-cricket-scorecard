<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match History - Cricket Scorecard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <div class="container py-4">
        <div class="page-header text-center mb-4"
            style="background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%); color: white; padding: 25px 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(13, 110, 253, 0.15);">
            <h1 class="display-5 mb-2"><strong>üìã Match History</strong></h1>
            <p class="mb-0" style="font-size: 0.95rem; opacity: 0.95;">Explore your complete cricket journey</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-12 d-flex justify-content-between align-items-center gap-2">
                <button class="btn btn-outline-primary px-4 py-2" onclick="window.close()"
                    style="border-radius: 10px; font-weight: 500; border-width: 2px;">
                    ‚Üê Back to Scorecard
                </button>
                <button class="btn btn-danger px-4 py-2" onclick="deleteAllMatches()"
                    style="border-radius: 10px; font-weight: 500;">
                    üóëÔ∏è Delete All
                </button>
            </div>
        </div>

        <div id="matchHistoryContainer">
            <!-- Matches will be loaded here -->
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="main.js"></script>
    <script>
        // Load and display all matches
        $(document).ready(function () {
            const history = getMatchHistory();
            const container = document.getElementById('matchHistoryContainer');

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <h4>No past matches found</h4>
                        <p>Complete a match and click "Start Fresh Match" to save it here.</p>
                    </div>
                `;
                return;
            }

            // Sort history by timestamp (newest first)
            const sortedHistory = [...history].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            // Group matches by matchName
            const groupedMatches = {};
            sortedHistory.forEach((match) => {
                if (!groupedMatches[match.matchName]) {
                    groupedMatches[match.matchName] = {};
                }
                if (match.inningsType === '1st') {
                    groupedMatches[match.matchName].first = match;
                } else if (match.inningsType === '2nd') {
                    groupedMatches[match.matchName].second = match;
                } else {
                    groupedMatches[match.matchName].single = match;
                }
            });

            let html = '';

            // Display all grouped matches (newest first)
            Object.keys(groupedMatches).forEach((matchName) => {
                const matchGroup = groupedMatches[matchName];
                const leadingMatchId = (matchGroup.single || matchGroup.first || matchGroup.second).matchId;

                // Get team names
                const matchData = matchGroup.second || matchGroup.first || matchGroup.single;
                const battingTeam = matchData.battingTeamName || "";
                const bowlingTeam = matchData.bowlingTeamName || "";
                let teamNamesHTML = "";
                if (battingTeam && bowlingTeam) {
                    teamNamesHTML = `<div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;">${battingTeam} vs ${bowlingTeam}</div>`;
                } else if (battingTeam || bowlingTeam) {
                    teamNamesHTML = `<div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;">${battingTeam || bowlingTeam}</div>`;
                }

                html += `<div class="card match-history-card">`;
                html += `<div class="card-header match-history-header d-flex justify-content-between align-items-center">`;
                html += `<div><h3 class="mb-0"><strong>${matchName}</strong></h3>${teamNamesHTML}</div>`;
                html += `<button class="btn btn-light btn-modern" onclick="downloadMatchPDF('${leadingMatchId}')">üì• Download PDF</button>`;
                html += `</div>`;
                html += `<div class="card-body p-4" style="background: white;">`;

                if (matchGroup.single) {
                    // Single innings match
                    const match = matchGroup.single;
                    const date = new Date(match.timestamp);
                    const formattedDate = date.toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    html += `<div class="text-center py-3">`;
                    html += `<div class="score-display text-primary" style="font-size: 3rem;">${match.finalScore}</div>`;
                    html += `<div class="meta-info mb-4" style="font-size: 1.1rem;">in ${match.totalOvers} overs ‚Ä¢ ${formattedDate}</div>`;
                    html += `<div class="d-flex gap-2 justify-content-center">`;
                    html += `<button class="btn btn-modern btn-modern-outline btn-lg" style="min-width: 200px;" onclick="showMatchDetails('${match.matchId}')">`;
                    html += `Details</button>`;
                    html += `<button class="btn btn-danger btn-lg" onclick="deleteMatch('${match.matchId}')" title="Delete this match">üóëÔ∏è</button>`;
                    html += `</div>`;
                    html += `</div>`;
                } else {
                    // Two innings match
                    html += `<div class="row g-4">`;

                    // 1st Innings
                    if (matchGroup.first) {
                        const match = matchGroup.first;
                        const teamName = match.battingTeamName ? ` (${match.battingTeamName})` : "";

                        // Format timing information
                        let timingHTML = "";
                        if (match.startTime && match.endTime) {
                            const startDate = new Date(match.startTime);
                            const endDate = new Date(match.endTime);
                            const startTime = startDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                            const endTime = endDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                            const duration = match.duration || Math.round((match.endTime - match.startTime) / 60000);
                            const hours = Math.floor(duration / 60);
                            const mins = duration % 60;
                            const durationText = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                            timingHTML = `<div class="meta-info" style="font-size: 0.85rem; color: #666; margin-top: 8px;">‚è±Ô∏è ${startTime} - ${endTime} (${durationText})</div>`;
                        }

                        html += `<div class="col-12 col-md-6">`;
                        html += `<div class="innings-box innings-box-1 text-center py-4">`;
                        html += `<div class="meta-info text-primary mb-1">1ST INNINGS${teamName}</div>`;
                        html += `<div class="score-display text-primary" style="font-size: 2.5rem;">${match.finalScore}</div>`;
                        html += `<div class="meta-info mb-4">in ${match.totalOvers} overs</div>`;
                        html += timingHTML;
                        html += `<div class="d-flex gap-2 justify-content-center">`;
                        html += `<button class="btn btn-modern btn-modern-outline px-4" onclick="showMatchDetails('${match.matchId}')">`;
                        html += `Details</button>`;
                        html += `<button class="btn btn-danger btn-sm" onclick="deleteMatch('${match.matchId}')" title="Delete this innings">üóëÔ∏è</button>`;
                        html += `</div></div></div>`;
                    }

                    // 2nd Innings
                    if (matchGroup.second) {
                        const match = matchGroup.second;
                        const firstInnings = matchGroup.first;
                        const teamName = match.battingTeamName ? ` (${match.battingTeamName})` : "";

                        // Determine result
                        let resultBadge = '';
                        if (firstInnings) {
                            const firstRuns = firstInnings.runs;
                            const secondRuns = match.runs;
                            if (secondRuns > firstRuns) {
                                resultBadge = '<span class="badge bg-success ms-2" style="font-size: 0.9rem;">Winner</span>';
                            } else if (secondRuns === firstRuns) {
                                resultBadge = '<span class="badge bg-warning ms-2" style="font-size: 0.9rem;">Tie</span>';
                            } else {
                                resultBadge = '<span class="badge bg-danger ms-2" style="font-size: 0.9rem;">Runner Up</span>';
                            }
                        }

                        // Format timing information
                        let timingHTML = "";
                        if (match.startTime && match.endTime) {
                            const startDate = new Date(match.startTime);
                            const endDate = new Date(match.endTime);
                            const startTime = startDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                            const endTime = endDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                            const duration = match.duration || Math.round((match.endTime - match.startTime) / 60000);
                            const hours = Math.floor(duration / 60);
                            const mins = duration % 60;
                            const durationText = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                            timingHTML = `<div class="meta-info" style="font-size: 0.85rem; color: #666; margin-top: 8px;">‚è±Ô∏è ${startTime} - ${endTime} (${durationText})</div>`;
                        }

                        html += `<div class="col-12 col-md-6">`;
                        html += `<div class="innings-box innings-box-2 text-center py-4">`;
                        html += `<div class="meta-info text-success mb-1">2ND INNINGS${teamName} ${resultBadge}</div>`;
                        html += `<div class="score-display text-success" style="font-size: 2.5rem;">${match.finalScore}</div>`;
                        html += `<div class="meta-info mb-4">in ${match.totalOvers} overs</div>`;
                        html += timingHTML;
                        html += `<div class="d-flex gap-2 justify-content-center">`;
                        html += `<button class="btn btn-modern btn-modern-outline px-4" style="border-color: #28a745; color: #28a745;" onclick="showMatchDetails('${match.matchId}')">`;
                        html += `Details</button>`;
                        html += `<button class="btn btn-danger btn-sm" onclick="deleteMatch('${match.matchId}')" title="Delete this innings">üóëÔ∏è</button>`;
                        html += `</div></div></div>`;
                    }

                    html += `</div>`; // End row

                    // Show timestamp
                    if (matchGroup.first || matchGroup.second) {
                        const match = matchGroup.second || matchGroup.first;
                        const date = new Date(match.timestamp);
                        const formattedDate = date.toLocaleDateString('en-IN', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        html += `<div class="text-center mt-4">`;
                        html += `<div class="meta-info" style="font-size: 1rem;">Played on ${formattedDate}</div>`;
                        html += `</div>`;
                    }
                }

                html += `</div>`; // End card-body
                html += `</div>`; // End match-card
            });

            container.innerHTML = html;
        });

        // Delete match function for this page
        function deleteMatch(matchId) {
            // Show confirmation dialog
            if (!confirm('Are you sure you want to delete this match? This action cannot be undone.')) {
                return; // User cancelled
            }

            try {
                const history = getMatchHistory();

                // Find and remove the match
                const updatedHistory = history.filter(match => match.matchId !== matchId);

                // Save updated history
                localStorage.setItem('cricketMatchHistory', JSON.stringify(updatedHistory));

                // Reload the page to refresh the display
                location.reload();

                console.log('Match deleted:', matchId);
            } catch (e) {
                console.error('Error deleting match:', e);
                alert('Failed to delete match. Please try again.');
            }
        }

        // Delete all matches function
        function deleteAllMatches() {
            // Show confirmation dialog
            if (!confirm('Are you sure you want to delete ALL matches? This action cannot be undone and will permanently delete your entire match history.')) {
                return; // User cancelled
            }

            // Double confirmation for safety
            if (!confirm('This will delete ALL your match history permanently. Are you absolutely sure?')) {
                return; // User cancelled
            }

            try {
                // Clear match history
                localStorage.removeItem('cricketMatchHistory');

                // Reset match counter to 0 so next match starts at 1
                localStorage.setItem('cricketMatchCounter', '0');

                // Reload the page to refresh the display
                location.reload();

                console.log('All matches deleted');
            } catch (e) {
                console.error('Error deleting all matches:', e);
                alert('Failed to delete matches. Please try again.');
            }
        }
    </script>

    <!-- Match Details Modal (same as in index.html) -->
    <div class="modal fade" id="matchDetailsModal" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="matchDetailsTitle">Match Details</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="matchDetailsBody">
                    <!-- Match details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>